

<html>
  <!DOCTYPE html>
  <html lang="zh-cn">
  <meta charset="UTF-8">
  <head>
    <title>boost::variant的实现</title>
  </head>

<body>


<div>
<span><div><br/></div><div>源码参考的是 1.69.0</div><div><br/></div><div>起因是好奇 operator&lt; 的实现方式。</div><div><br/></div><div><br/></div><div>boost/variant/variant.hpp#2381</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">if</span> <span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">which</span><span style="color: #d4d4d4;">()</span> <span style="color: #d4d4d4;">!=</span> <span style="color: #d4d4d4;">rhs.</span><span style="color: #dcdcaa;">which</span><span style="color: #d4d4d4;">())</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">which</span><span style="color: #d4d4d4;">()</span> <span style="color: #d4d4d4;">&lt;</span> <span style="color: #d4d4d4;">rhs.</span><span style="color: #dcdcaa;">which</span><span style="color: #d4d4d4;">();</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">detail::variant::comparer</span><span style="color: #d4d4d4;">&lt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">variant, detail::variant::less_comp</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">&gt;</span> <span style="color: #dcdcaa;">visitor</span><span style="color: #d4d4d4;">(</span><span style="color: #d4d4d4;">*</span><span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">);</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #d4d4d4;">rhs.</span><span style="color: #dcdcaa;">apply_visitor</span><span style="color: #d4d4d4;">(visitor);</span></div><div><br/></div><div>which() 成员不同的话直接比较which(), 很合理 ，相同时去看这个 apply_visitor 是怎么做到的</div><div><br/></div><div>boost/variant/variant.hpp#2500</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">apply_visitor</span><span style="color: #d4d4d4;">(Visitor</span><span style="color: #d4d4d4;">&amp;</span> <span style="color: #d4d4d4;">visitor)</span> <span style="color: #569cd6;">const</span><span style="color: #d4d4d4;">&amp;&amp;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">detail::variant::invoke_visitor</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">Visitor,</span> <span style="color: #569cd6;">true</span><span style="color: #d4d4d4;">&gt;</span> <span style="color: #dcdcaa;">invoker</span><span style="color: #d4d4d4;">(visitor);</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #569cd6;">this</span><span style="color: #d4d4d4;">-&gt;</span><span style="color: #dcdcaa;">internal_apply_visitor</span><span style="color: #d4d4d4;">(invoker);</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">}</span></div><div><br/></div><div>那  internal_apply_visitor 又是什么</div><div><br/></div><div><br/></div><div><br/></div><div>boost/variant/variant.hpp#2475</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">internal_apply_visitor</span><span style="color: #d4d4d4;">(Visitor</span><span style="color: #d4d4d4;">&amp;</span> <span style="color: #d4d4d4;">visitor)</span> <span style="color: #569cd6;">const</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #dcdcaa;">internal_apply_visitor_impl</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">which_,</span> <span style="color: #dcdcaa;">which</span><span style="color: #d4d4d4;">(), visitor, storage_.</span><span style="color: #dcdcaa;">address</span><span style="color: #d4d4d4;">()</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">);</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">}</span></div><div><br/></div><div>storage_t 在 boost/variant/variant.hpp#1430</div><div><br/></div><div>internal_apply_visitor_impl:</div><div><br/></div><div>boost/variant/variant.hpp#2443</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">internal_apply_visitor_impl</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">int</span> <span style="color: #d4d4d4;">internal_which</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">int</span> <span style="color: #d4d4d4;">logical_which</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, Visitor</span><span style="color: #d4d4d4;">&amp;</span> <span style="color: #d4d4d4;">visitor</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, VoidPtrCV storage</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #d4d4d4;">mpl::int_</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">&gt;</span> <span style="color: #d4d4d4;">first_which;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">mpl::begin</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">internal_types</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #d4d4d4;">::type first_it;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">mpl::end</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">internal_types</span><span style="color: #d4d4d4;">&gt;</span><span style="color: #d4d4d4;">::type last_it;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #d4d4d4;">detail::variant::visitation_impl_step</span><span style="color: #d4d4d4;">&lt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">first_it, last_it</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">&gt;</span> <span style="color: #d4d4d4;">first_step;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #dcdcaa;">detail::variant::visitation_impl</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">internal_which, logical_which</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, visitor, storage,</span> <span style="color: #dcdcaa;">mpl::false_</span><span style="color: #d4d4d4;">()</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #dcdcaa;">never_uses_backup_flag</span><span style="color: #d4d4d4;">()</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">static_cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">first_which</span><span style="color: #d4d4d4;">*&gt;</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">),</span> <span style="color: #569cd6;">static_cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">first_step</span><span style="color: #d4d4d4;">*&gt;</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">);</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">}</span></div><div><br/></div><div><br/></div><div>visitation_impl：</div><div><br/></div><div>在 boost/variant/visitation_impl.hpp 中有两个定义，在第5个参数上发生重载：</div><div><br/></div><div>真正调用的是这个版本：</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">template</span> <span style="color: #d4d4d4;">&lt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">Which,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">step0</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">Visitor,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">VoidPtrCV</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">NoBackupFlag</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">&gt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">inline</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">BOOST_VARIANT_AUX_GENERIC_RESULT_TYPE</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">Visitor::result_type)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">visitation_impl</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">const</span> <span style="color: #569cd6;">int</span> <span style="color: #d4d4d4;">internal_which,</span> <span style="color: #569cd6;">const</span> <span style="color: #569cd6;">int</span> <span style="color: #d4d4d4;">logical_which</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, Visitor</span><span style="color: #d4d4d4;">&amp;</span> <span style="color: #d4d4d4;">visitor, VoidPtrCV storage</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, mpl::false_</span> <span style="color: #6a9955;">// is_apply_visitor_unrolled</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, NoBackupFlag no_backup_flag</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, Which</span><span style="color: #d4d4d4;">*</span> <span style="color: #d4d4d4;">=</span> <span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, step0</span><span style="color: #d4d4d4;">*</span> <span style="color: #d4d4d4;">=</span> <span style="color: #b5cea8;">0</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">// Typedef apply_visitor_unrolled steps and associated types...</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_VARIANT_AUX_APPLY_VISITOR_STEP_TYPEDEF</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">z, N, _</span><span style="color: #569cd6;">)</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef typename</span> <span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(step,N)::type</span> <span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(T,N);</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef typename</span> <span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(step,N)::next</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(step,</span> <span style="color: #dcdcaa;">BOOST_PP_INC</span><span style="color: #569cd6;">(N));</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">/**/</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">BOOST_PP_REPEAT</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">BOOST_VARIANT_VISITATION_UNROLLING_LIMIT</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, BOOST_VARIANT_AUX_APPLY_VISITOR_STEP_TYPEDEF</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, _</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># undef</span> <span style="color: #dcdcaa;">BOOST_VARIANT_AUX_APPLY_VISITOR_STEP_TYPEDEF</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">// ...switch on the target which-index value...</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">switch</span> <span style="color: #d4d4d4;">(logical_which)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">// ...applying the appropriate case:</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_VARIANT_AUX_APPLY_VISITOR_STEP_CASE</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">z, N, _</span><span style="color: #569cd6;">)</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">case</span> <span style="color: #569cd6;">(Which::value</span> <span style="color: #d4d4d4;">+</span> <span style="color: #569cd6;">(N)):</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #569cd6;">(visitation_impl_invoke)(</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">internal_which, visitor, storage</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">, static_cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(T,N)</span><span style="color: #d4d4d4;">*&gt;</span><span style="color: #569cd6;">(</span><span style="color: #b5cea8;">0</span><span style="color: #569cd6;">)</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">, no_backup_flag,</span> <span style="color: #b5cea8;">1L</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">);</span> <span style="color: #d7ba7d;">\</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">/**/</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">BOOST_PP_REPEAT</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">BOOST_VARIANT_VISITATION_UNROLLING_LIMIT</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, BOOST_VARIANT_AUX_APPLY_VISITOR_STEP_CASE</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, _</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># undef</span> <span style="color: #dcdcaa;">BOOST_VARIANT_AUX_APPLY_VISITOR_STEP_CASE</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">default</span><span style="color: #d4d4d4;">:</span> <span style="color: #c586c0;">break</span><span style="color: #d4d4d4;">;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">}</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">// If not handled in this iteration, continue unrolling:</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #d4d4d4;">mpl::int_</span><span style="color: #d4d4d4;">&lt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">Which::value</span> <span style="color: #d4d4d4;">+</span> <span style="color: #d4d4d4;">(BOOST_VARIANT_VISITATION_UNROLLING_LIMIT)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">&gt;</span> <span style="color: #d4d4d4;">next_which;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #9cdcfe;">BOOST_PP_CAT</span><span style="color: #d4d4d4;">(step, BOOST_VARIANT_VISITATION_UNROLLING_LIMIT)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">next_step;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">next_step::type next_type;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">is_same</span><span style="color: #d4d4d4;">&lt;</span> <span style="color: #d4d4d4;">next_type,apply_visitor_unrolled</span> <span style="color: #d4d4d4;">&gt;</span><span style="color: #d4d4d4;">::type</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">is_apply_visitor_unrolled;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #dcdcaa;">detail::variant::visitation_impl</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">internal_which, logical_which</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, visitor, storage</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #dcdcaa;">is_apply_visitor_unrolled</span><span style="color: #d4d4d4;">()</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, no_backup_flag</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">static_cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">next_which</span><span style="color: #d4d4d4;">*&gt;</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">),</span> <span style="color: #569cd6;">static_cast</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">next_step</span><span style="color: #d4d4d4;">*&gt;</span><span style="color: #d4d4d4;">(</span><span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">);</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">}</span></div><div><br/></div><div><br/></div><div><br/></div><div>这个版本会 force return:</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">template</span> <span style="color: #d4d4d4;">&lt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">W,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">S</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">Visitor,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">VPCV</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">NBF</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">&gt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">inline</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">BOOST_VARIANT_AUX_GENERIC_RESULT_TYPE</span><span style="color: #d4d4d4;">(</span><span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">Visitor::result_type)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #dcdcaa;">visitation_impl</span><span style="color: #d4d4d4;">(</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">int</span><span style="color: #d4d4d4;">,</span> <span style="color: #569cd6;">int</span><span style="color: #d4d4d4;">, Visitor</span><span style="color: #d4d4d4;">&amp;</span><span style="color: #d4d4d4;">, VPCV</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, mpl::true_</span> <span style="color: #6a9955;">// is_apply_visitor_unrolled</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">, NBF, W</span><span style="color: #d4d4d4;">*</span> <span style="color: #d4d4d4;">=</span> <span style="color: #b5cea8;">0</span><span style="color: #d4d4d4;">, S</span><span style="color: #d4d4d4;">*</span> <span style="color: #d4d4d4;">=</span> <span style="color: #b5cea8;">0</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #6a9955;">// should never be here at runtime!</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #569cd6;">typename</span> <span style="color: #d4d4d4;">Visitor::result_type result_type;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;">return</span> <span style="color: #d4d4d4;">::boost::detail::variant::forced_return</span><span style="color: #d4d4d4;">&lt;</span> <span style="color: #d4d4d4;">result_type</span> <span style="color: #d4d4d4;">&gt;</span><span style="color: #d4d4d4;">();</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">}</span></div><div><br/></div><div>至于 mpl::false_ 和 mpl_true_ 的定义， 在 boost/interprocess/detail/mpl.hpp</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">template</span> <span style="color: #d4d4d4;">&lt;</span><span style="color: #569cd6;">class</span> <span style="color: #4ec9b0;">T</span><span style="color: #d4d4d4;">, T val</span><span style="color: #d4d4d4;">&gt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">struct</span> <span style="color: #4ec9b0;">integral_constant</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">static</span> <span style="color: #569cd6;">const</span> <span style="color: #d4d4d4;">T value</span> <span style="color: #d4d4d4;">=</span> <span style="color: #d4d4d4;">val;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #d4d4d4;">integral_constant</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #d4d4d4;">T,val</span><span style="color: #d4d4d4;">&gt;</span> <span style="color: #d4d4d4;">type;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">};</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">template</span><span style="color: #d4d4d4;">&lt;</span> <span style="color: #569cd6;">bool</span> <span style="color: #d4d4d4;">C_</span> <span style="color: #d4d4d4;">&gt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">struct</span> <span style="color: #4ec9b0;">bool_</span> <span style="color: #d4d4d4;">: integral_constant&lt;</span><span style="color: #569cd6;">bool</span><span style="color: #d4d4d4;">, C_&gt;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">{</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">static</span> <span style="color: #569cd6;">const</span> <span style="color: #569cd6;">bool</span> <span style="color: #d4d4d4;">value</span> <span style="color: #d4d4d4;">=</span> <span style="color: #d4d4d4;">C_;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">};</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #d4d4d4;">bool_</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #569cd6;">true</span><span style="color: #d4d4d4;">&gt;</span> <span style="color: #d4d4d4;">true_;</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #569cd6;">typedef</span> <span style="color: #d4d4d4;">bool_</span><span style="color: #d4d4d4;">&lt;</span><span style="color: #569cd6;">false</span><span style="color: #d4d4d4;">&gt;</span> <span style="color: #d4d4d4;">false_;</span></div><div><br/></div><div><br/></div><div>在实际调用的函数中，看到 BOOST_PP_CAT 这个宏，可以查到</div><div><br/></div><div>boost/preprocessor/cat.hpp</div><div><br/></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># if</span> <span style="color: #d4d4d4;">~</span><span style="color: #dcdcaa;">BOOST_PP_CONFIG_FLAGS</span><span style="color: #569cd6;">()</span> <span style="color: #d4d4d4;">&amp;</span> <span style="color: #dcdcaa;">BOOST_PP_CONFIG_MWCC</span><span style="color: #569cd6;">()</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">a, b</span><span style="color: #569cd6;">)</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_I</span><span style="color: #569cd6;">(a, b)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># else</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_PP_CAT</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">a, b</span><span style="color: #569cd6;">)</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_OO</span><span style="color: #569cd6;">((a, b))</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_OO</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">par</span><span style="color: #569cd6;">) BOOST_PP_CAT_I ## par</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># endif</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">#</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># if</span> <span style="color: #569cd6;">(</span><span style="color: #d4d4d4;">~</span><span style="color: #dcdcaa;">BOOST_PP_CONFIG_FLAGS</span><span style="color: #569cd6;">()</span> <span style="color: #d4d4d4;">&amp;</span> <span style="color: #dcdcaa;">BOOST_PP_CONFIG_MSVC</span><span style="color: #569cd6;">())</span> <span style="color: #d4d4d4;">||</span> <span style="color: #569cd6;">(</span><span style="color: #c586c0;">defined</span><span style="color: #569cd6;">(</span><span style="color: #dcdcaa;">__INTEL_COMPILER</span><span style="color: #569cd6;">)</span> <span style="color: #d4d4d4;">&amp;&amp;</span> <span style="color: #dcdcaa;">__INTEL_COMPILER</span> <span style="color: #d4d4d4;">&gt;=</span> <span style="color: #b5cea8;">1700</span><span style="color: #569cd6;">)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_I</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">a, b</span><span style="color: #569cd6;">) a ## b</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># else</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_I</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">a, b</span><span style="color: #569cd6;">)</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_II</span><span style="color: #569cd6;">(</span><span style="color: #d4d4d4;">~</span><span style="color: #569cd6;">, a ## b)</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># define</span> <span style="color: #dcdcaa;">BOOST_PP_CAT_II</span><span style="color: #569cd6;">(</span><span style="color: #9cdcfe;">p, res</span><span style="color: #569cd6;">) res</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #c586c0;"># endif</span></div><div style="background-color:rgb(30, 30, 30);color:rgb(212, 212, 212);font-family:Consolas, &quot;Courier New&quot;, monospace;font-size:14px;line-height:19px;white-space:pre;"><span style="color: #d4d4d4;">#</span></div><div><br/></div><div><br/></div><div>用来做字符串粘贴与宏展开。</div><div><br/></div><div>看到这里猜测，boost::variant 的比较运算是通过宏展开，对模板参数逐个比较实现的。</div><div>需要进一步读源码验证，可以去看 boost::variant 的构造函数是怎么做的。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html>